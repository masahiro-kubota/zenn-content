---
title: "Difyを使ったchatbotをローカルサーバーからデプロイしてみた"
emoji: "✨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [Dify]
published: false
---

大きなgithubリポジトリのQ&Achatbotができたらいいなと思い、Difyでchatbotを作ってみました。

今回は自動運転ソフトウェアのAutowareをのchatbotに挑戦しました。
https://github.com/autowarefoundation/autoware

Difyの使い方は色んな人がテックブログやyoutubeで解説しています。自分はこれを見ました。めちゃわかりやすいです。
https://www.youtube.com/watch?v=O_bmmDWIjTc&t=2050s

Difyでは、KnowledgeというタブでRAGが簡単に使えます。
RAGは一回の入力に収めることができないほどのデータからいい感じの部分を抽出して、入力にするみたいなやつです（詳細は詳しい人にまかせる。。。）。
![alt text](/images/dify/image.png)

RAGを使うことによって、chatbotが大きなgithubリポジトリを参照できるようになるわけですね。

ということで、AutowareのソースコードをまるごとRAGに入れればいいのかー。テキトーにAWSとかからデプロイすればみんな使えてハッピーとか思ってました（AWSはほとんど使ったことないですが）。

ところが、ちょいちょい問題発生したのでそこらへんを書いときます。

# Knowledgeにアップロードできるデータ量の上限が15MB
Difyが提供するクラウド上でchatbotを作ることもできるのですが、ローカルでも同じことができるみたいなのでローカルでやりました。

ここに書いてあるように、環境変数を変更する必要があります。
https://github.com/langgenius/dify/issues/3865

docker-compose.yamlも変える必要がありました。



# Knowledgeのアップロードが固まる
先程の手順で上限を1.5GB程度まで上げました。
autoware.txt全体をembeddingしようとするとかなり時間がかかるのでとりあえずAutowareのPlanningコンポーネントだけを使いました。これでも2~3時間かかった気がします。

ボタンは連打しない方がいいです。
固まったと思っても、docker内でボタンを押した回数だけ処理が走ってより遅くなります。そうなってしまった場合は、docker compose stopで再起動したほうがいいです。

がちゃがちゃやってると、embeddingのレートがリミットを超えちゃうことがあったので、焦らず落ち着いて待った方がいいです。





# Knowledgeがエクスポートできない
AWSでデプロイしようとしてた自分にはこれが一番でかかったです。


つまり、embeddingの処理をクラウドでやる必要があるため、その分メモリも用意する必要があるわけです。さすがに安いプランの2GBで処理していたら、全然終わらない気がしたのでここで、ローカルデプロイに変更しました（試したわけではないので、できるかもしれません）。

ローカルでデプロイする方法はこれが参考になります。

localhost:80でうまくいかなくて、localhost:8080だとうまくいったので.envの該当箇所を80から8080に変えておきます。

このリンクを共有しておけばそれ以外の編集画面ではログインが必要になるので外部の人はアクセスできなくなるわけですね。


こんな感じで、ちょいちょい躓きましたが無事にローカルでデプロイできました。終わってみれば以外と簡単にできたかもです。
Difyの限界として、上記以外にもループみたいなフローが組みづらいというのもあるっぽいです。

open interpreterみたいなエージェントを作ろうとすると結構難しいかもです。
![alt text](/images/dify/image-1.png)
*open interpreterの構造*

open interpreterはこちらが詳しいです（こちらの図をお借りしました）。
https://tech.every.tv/entry/2023/10/11/152257

エージェントのテンプレートもそんなに多くないので、これからなのかもですね。
![alt text](/images/dify/image-2.png)

余談ですが、DifyのPRで動いているbot中々いい感じだなーと思いました。これ使ってみたいですね。
https://github.com/langgenius/dify/issues/3865#issuecomment-2078539228

